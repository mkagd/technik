# üéâ DZIE≈É 3 ZAKO≈ÉCZONY - API Zam√≥wie≈Ñ + Magazyny Osobiste

## ‚úÖ CO ZOSTA≈ÅO ZROBIONE:

### üì¶ CZƒò≈öƒÜ A: API Zam√≥wie≈Ñ Czƒô≈õci (`/api/part-requests`)

#### 1. **GET /api/part-requests** - Lista zam√≥wie≈Ñ
```javascript
GET /api/part-requests                              // Wszystkie
GET /api/part-requests?id=PR-2025-10-03-1234       // Konkretne zam√≥wienie
GET /api/part-requests?requestedBy=EMP25189002     // Zam√≥wienia utworzone przez
GET /api/part-requests?requestedFor=EMP25189002    // Zam√≥wienia dla
GET /api/part-requests?status=pending              // Po statusie
GET /api/part-requests?status=pending,approved     // Wiele status√≥w
GET /api/part-requests?urgency=urgent              // Po pilno≈õci
GET /api/part-requests?limit=10                    // Limit
```

**Statusy:**
- `pending` - Oczekuje na zatwierdzenie
- `approved` - Zatwierdzone przez logistyka
- `rejected` - Odrzucone
- `ordered` - Zam√≥wione u dostawcy
- `delivered` - Dostarczone
- `completed` - Zako≈Ñczone (czƒô≈õci u≈ºyte)

---

#### 2. **POST /api/part-requests** - Nowe zam√≥wienie (serwisant)
```javascript
POST /api/part-requests
Body: {
  requestedBy: "EMP25189002",      // Serwisant
  requestedFor: "EMP25189002",     // Ten sam = zamawia dla siebie
  ocrId: "OCR-2025-10-001",        // Opcjonalnie: link do OCR
  deviceInfo: {                     // Lub rƒôcznie
    brand: "Samsung",
    model: "WW90T4540AE",
    serialNumber: "SW123456"
  },
  parts: [
    {
      partId: "PART001",
      quantity: 2,
      preferredSupplierId: "SUP001"
    }
  ],
  urgency: "standard",              // standard, tomorrow, urgent
  preferredDelivery: "paczkomat",   // paczkomat, office, technician-address
  paczkomatId: "KRA01M",
  notes: "Pilne - klient czeka"
}
```

**Funkcje:**
- ‚úÖ Automatyczna detekcja **po deadline** (15:00 default)
- ‚úÖ Express charge **+25z≈Ç** je≈õli urgent po deadline
- ‚úÖ Link do OCR (deviceInfo z rozpoznanej tabliczki)
- ‚úÖ Notyfikacja do logistyka
- ‚úÖ Specjalna notyfikacja üö® je≈õli urgent po deadline

---

#### 3. **POST /api/part-requests/admin-order** - Admin zamawia dla serwisanta
```javascript
POST /api/part-requests/admin-order
Body: {
  adminId: "EMPADMIN001",          // Admin/logistyk
  technicianId: "EMP25189002",     // Serwisant dla kt√≥rego zamawia
  orderId: "ORD1024",              // Opcjonalnie: ID zlecenia
  deviceInfo: {
    brand: "Samsung",
    model: "WW90T4540AE"
  },
  parts: [
    {
      partId: "PART001",
      quantity: 1
    }
  ],
  urgency: "urgent",
  preferredDelivery: "paczkomat",
  paczkomatId: "KRA01M",
  reason: "Serwisant zgubi≈Ç czƒô≈õƒá",
  autoApprove: true,               // ‚úÖ Admin mo≈ºe od razu zatwierdziƒá!
  notes: "Express - klient czeka od wczoraj"
}
```

**Funkcje:**
- ‚úÖ **isAdminOrder: true** - flagka ≈ºe admin zamawia
- ‚úÖ **autoApprove** - admin mo≈ºe od razu zatwierdziƒá (pominƒÖƒá workflow)
- ‚úÖ **adminOrderReason** - pow√≥d zam√≥wienia przez admina
- ‚úÖ Notyfikacja do serwisanta: "Admin zam√≥wi≈Ç dla Ciebie"
- ‚úÖ Notyfikacja do innych logistyk√≥w (je≈õli nie auto-approve)
- ‚úÖ Sprawdzanie uprawnie≈Ñ (role: admin, logistyk)

---

#### 4. **PUT /api/part-requests/approve?requestId=...** - Zatwierd≈∫ zam√≥wienie
```javascript
PUT /api/part-requests/approve?requestId=PR-2025-10-03-1234
Body: {
  approvedBy: "EMPLOGISTYK001",
  finalDelivery: "paczkomat",      // Ostateczna decyzja logistyka
  paczkomatId: "KRA01M",
  logisticianNotes: "Konsolidacja z zam√≥wieniem Tomka",
  estimatedDelivery: "2025-10-05"
}
```

**Funkcje:**
- ‚úÖ Status ‚Üí `approved`
- ‚úÖ Logistyk mo≈ºe zmieniƒá metodƒô dostawy (finalDelivery != preferredDelivery)
- ‚úÖ Notatki logistyka
- ‚úÖ Notyfikacja do serwisanta: "‚úÖ Zam√≥wienie zatwierdzone"

---

#### 5. **PUT /api/part-requests/reject?requestId=...** - Odrzuƒá zam√≥wienie
```javascript
PUT /api/part-requests/reject?requestId=PR-2025-10-03-1234
Body: {
  rejectedBy: "EMPLOGISTYK001",
  rejectionReason: "Czƒô≈õƒá niedostƒôpna u dostawcy, zam√≥w alternatywnƒÖ"
}
```

**Funkcje:**
- ‚úÖ Status ‚Üí `rejected`
- ‚úÖ Wymagany pow√≥d odrzucenia
- ‚úÖ Notyfikacja do serwisanta: "‚ùå Zam√≥wienie odrzucone. Pow√≥d: ..."

---

#### 6. **PUT /api/part-requests/delivered?requestId=...** - Potwierd≈∫ dostawƒô
```javascript
PUT /api/part-requests/delivered?requestId=PR-2025-10-03-1234
Body: {
  confirmedBy: "EMPLOGISTYK001",   // Lub sam serwisant
  trackingNumber: "DPD1234567890",
  actualDeliveryDate: "2025-10-05T10:30:00Z",
  notes: "Odebrano z paczkomatu"
}
```

**Funkcje:**
- ‚úÖ Status ‚Üí `delivered`
- ‚úÖ Mo≈ºe potwierdziƒá logistyk LUB serwisant
- ‚úÖ Notyfikacja wzajemna (kto potwierdzi≈Ç ‚Üí notyfikacja dla drugiego)

---

### üì¶ CZƒò≈öƒÜ B: API Magazyn√≥w Osobistych (`/api/inventory/personal`)

#### 1. **GET /api/inventory/personal?employeeId=...** - Magazyn pracownika
```javascript
GET /api/inventory/personal?employeeId=EMP25189002
```

**Response:**
```json
{
  "success": true,
  "inventory": {
    "inventoryId": "PI-001",
    "employeeId": "EMP25189002",
    "employeeName": "Adam Nowak",
    "vehicle": "VW Caddy (KR 12345)",
    "parts": [
      {
        "partId": "PART001",
        "partName": "≈Åo≈ºysko bƒôbna Samsung",
        "partNumber": "DC97-16151A",
        "quantity": 0,
        "location": "Schowek boczny",
        "status": "available",
        "price": 85,
        "category": "Pralka",
        "assignedBy": "EMPLOGISTYK001",
        "assignedDate": "2025-10-01T10:00:00Z"
      }
    ],
    "statistics": {
      "totalParts": 0,
      "totalValue": 0,
      "lastUpdated": "2025-10-03T12:00:00Z"
    }
  }
}
```

**Funkcje:**
- ‚úÖ Wzbogacone dane (partName, price, category z parts-inventory.json)
- ‚úÖ Automatyczne utworzenie pustego magazynu je≈õli nie istnieje
- ‚úÖ Statystyki na ≈ºywo

---

#### 2. **POST /api/inventory/personal** - Przypisz czƒô≈õƒá (po dostawie)
```javascript
POST /api/inventory/personal
Body: {
  employeeId: "EMP25189002",
  partId: "PART001",
  quantity: 2,
  location: "Schowek boczny",
  assignedBy: "EMPLOGISTYK001",
  supplierOrderId: "SO-2025-10-001",  // Opcjonalnie
  notes: "Z konsolidacji z Tomkiem"
}
```

**Funkcje:**
- ‚úÖ Je≈õli czƒô≈õƒá ju≈º istnieje ‚Üí **zwiƒôksz ilo≈õƒá**
- ‚úÖ Je≈õli nowa ‚Üí **dodaj do magazynu**
- ‚úÖ Automatyczne przeliczanie statystyk (totalParts, totalValue)
- ‚úÖ Notyfikacja do serwisanta: "üì¶ Nowe czƒô≈õci w magazynie!"
- ‚úÖ Historia restockowania (lastRestocked, restockedBy)

---

#### 3. **POST /api/inventory/personal/use** - U≈ºyj czƒô≈õci (podczas serwisu)
```javascript
POST /api/inventory/personal/use
Body: {
  employeeId: "EMP25189002",
  orderId: "ORD1024",
  parts: [
    {
      partId: "PART001",
      quantity: 2,
      installationNotes: "Wymiana ≈Ço≈ºyska - 90 minut pracy"
    }
  ],
  addToInvoice: true,               // Default: true
  invoiceId: "INV-2025-10-123",
  customerInfo: {
    name: "Jan Kowalski",
    address: "Krak√≥w"
  },
  warranty: 12                       // MiesiƒÖce
}
```

**Funkcje:**
- ‚úÖ **Sprawdzanie dostƒôpno≈õci** przed u≈ºyciem (error je≈õli za ma≈Ço)
- ‚úÖ **Automatyczne odejmowanie** z magazynu
- ‚úÖ **Usuwanie czƒô≈õci** je≈õli quantity = 0
- ‚úÖ **Zapis do part-usage.json** (historia u≈ºycia)
- ‚úÖ **Low stock alert** ‚Üí notyfikacja do logistyka je≈õli 0!
- ‚úÖ Obliczanie totalValue (quantity √ó price)
- ‚úÖ Link do faktury

**Response:**
```json
{
  "success": true,
  "usage": {
    "usageId": "PU-2025-10-03-1234",
    "employeeId": "EMP25189002",
    "orderId": "ORD1024",
    "parts": [
      {
        "partId": "PART001",
        "partName": "≈Åo≈ºysko bƒôbna Samsung",
        "quantity": 2,
        "unitPrice": 85,
        "totalPrice": 170
      }
    ],
    "totalValue": 170,
    "addedToInvoice": true,
    "invoiceId": "INV-2025-10-123"
  },
  "inventory": { /* zaktualizowany magazyn */ },
  "lowStockAlert": true,
  "outOfStockParts": ["≈Åo≈ºysko bƒôbna Samsung"]
}
```

---

#### 4. **GET /api/inventory/personal/history** - Historia u≈ºycia
```javascript
GET /api/inventory/personal/history?employeeId=EMP25189002
GET /api/inventory/personal/history?orderId=ORD1024
GET /api/inventory/personal/history?usageId=PU-2025-10-03-1234
GET /api/inventory/personal/history?dateFrom=2025-10-01&dateTo=2025-10-03
GET /api/inventory/personal/history?limit=10
```

**Response:**
```json
{
  "success": true,
  "usageHistory": [
    {
      "usageId": "PU-2025-10-03-1234",
      "employeeId": "EMP25189002",
      "employeeName": "Adam Nowak",
      "orderId": "ORD1024",
      "usageDate": "2025-10-03T14:30:00Z",
      "parts": [...],
      "totalValue": 170,
      "addedToInvoice": true,
      "invoiceId": "INV-2025-10-123"
    }
  ],
  "statistics": {
    "totalUsages": 15,
    "totalParts": 45,
    "totalValue": 3850
  }
}
```

---

#### 5. **GET /api/inventory/personal/stats** - Statystyki magazynu
```javascript
GET /api/inventory/personal/stats?employeeId=EMP25189002
GET /api/inventory/personal/stats?employeeId=EMP25189002&period=month
GET /api/inventory/personal/stats?employeeId=EMP25189002&period=week
```

**Response:**
```json
{
  "success": true,
  "employeeId": "EMP25189002",
  "period": "month",
  "currentInventory": {
    "totalParts": 6,
    "totalValue": 355,
    "uniqueParts": 5
  },
  "usage": {
    "totalUsages": 8,
    "totalPartsUsed": 18,
    "totalValueUsed": 1520
  },
  "topUsedParts": [
    {
      "partId": "PART001",
      "partName": "≈Åo≈ºysko bƒôbna Samsung",
      "timesUsed": 4,
      "quantityUsed": 8,
      "totalValue": 680
    }
  ],
  "lowStockParts": [
    {
      "partId": "PART001",
      "partName": "≈Åo≈ºysko bƒôbna Samsung",
      "quantity": 0,
      "location": "Schowek boczny"
    }
  ],
  "lowStockAlert": true
}
```

---

#### 6. **PUT /api/inventory/personal/adjust** - Rƒôczna korekta magazynu
```javascript
PUT /api/inventory/personal/adjust
Body: {
  employeeId: "EMP25189002",
  partId: "PART001",
  adjustment: "add",              // 'add', 'remove', 'set'
  quantity: 2,                    // Ile dodaƒá/odjƒÖƒá/ustawiƒá
  reason: "Uszkodzenie podczas monta≈ºu",  // WYMAGANY!
  adjustedBy: "EMPLOGISTYK001",
  location: "Schowek boczny",     // Opcjonalnie: zmie≈Ñ lokalizacjƒô
  notes: "Czƒô≈õƒá uszkodzona - zwrot do dostawcy"
}
```

**Typy korekt:**
- `add` - Dodaj X sztuk
- `remove` - Odejmij X sztuk
- `set` - Ustaw na X sztuk (bezwzglƒôdna warto≈õƒá)

**Funkcje:**
- ‚úÖ Historia korekt (adjustmentHistory w ka≈ºdej czƒô≈õci)
- ‚úÖ Wymagany pow√≥d (reason)
- ‚úÖ Notyfikacja do serwisanta: "üîß Korekta magazynu"
- ‚úÖ Low stock alert je≈õli nowy stan = 0
- ‚úÖ Audit trail (kto, kiedy, dlaczego)

---

### üì¶ CZƒò≈öƒÜ C: API Notyfikacji (`/api/notifications`)

#### 1. **GET /api/notifications** - Lista notyfikacji
```javascript
GET /api/notifications                          // Wszystkie
GET /api/notifications?userId=EMP25189002      // Dla konkretnego u≈ºytkownika + globalne
GET /api/notifications?userId=null             // Tylko globalne
GET /api/notifications?type=error              // Po typie
GET /api/notifications?read=false              // Tylko nieprzeczytane
GET /api/notifications?limit=20
```

**Typy:**
- `info` - Informacja
- `success` - Sukces
- `warning` - Ostrze≈ºenie
- `error` - B≈ÇƒÖd / Pilne

---

#### 2. **PUT /api/notifications** - Oznacz jako przeczytane
```javascript
PUT /api/notifications
Body: {
  notificationIds: [1759467786996, 1759467787167],  // Array lub single
  markAll: false                                     // true = wszystkie
}
```

---

#### 3. **DELETE /api/notifications** - Usu≈Ñ notyfikacje
```javascript
DELETE /api/notifications
Body: {
  notificationIds: [1759467786996],  // Konkretne
  deleteAll: true,                    // Wszystkie przeczytane
  olderThan: 30                       // Starsze ni≈º 30 dni
}
```

---

## üîî SYSTEM NOTYFIKACJI

### Automatyczne notyfikacje wysy≈Çane przez system:

#### **Part Requests:**
1. ‚úÖ **Nowe zam√≥wienie** ‚Üí logistyk
   - `üî¥ PILNE` je≈õli urgent
   - `‚ö†Ô∏è NA JUTRO` je≈õli tomorrow
   
2. ‚úÖ **Express po deadline** ‚Üí logistyk
   - `üö® Express po deadline! (+25z≈Ç)`
   
3. ‚úÖ **Admin zamawia dla serwisanta** ‚Üí serwisant + logistyk
   - `üõí Admin zam√≥wi≈Ç dla Ciebie czƒô≈õci`
   
4. ‚úÖ **Zam√≥wienie zatwierdzone** ‚Üí serwisant
   - `‚úÖ Zam√≥wienie zatwierdzone. Dostawa: paczkomat KRA01M`
   
5. ‚úÖ **Zam√≥wienie odrzucone** ‚Üí serwisant
   - `‚ùå Zam√≥wienie odrzucone. Pow√≥d: ...`
   
6. ‚úÖ **Czƒô≈õci dostarczone** ‚Üí serwisant (lub logistyk)
   - `üì¶ Czƒô≈õci dostarczone!`

#### **Personal Inventory:**
1. ‚úÖ **Nowe czƒô≈õci w magazynie** ‚Üí serwisant
   - `üì¶ Nowe czƒô≈õci w magazynie! (2 szt)`
   
2. ‚úÖ **Low stock alert** ‚Üí logistyk
   - `‚ö†Ô∏è Low stock alert! Stan magazynu: 0`
   
3. ‚úÖ **Korekta magazynu** ‚Üí serwisant
   - `üîß Korekta magazynu: +2 szt. Pow√≥d: ...`

---

## üéØ KLUCZOWE FEATURES

### 1. **Admin mo≈ºe zamawiaƒá dla innych** ‚úÖ
```javascript
// Scenariusz: Serwisant dzwoni "Zgub≈Çem czƒô≈õƒá!"
POST /api/part-requests/admin-order
{
  adminId: "EMPADMIN001",
  technicianId: "EMP25189002",
  autoApprove: true,  // Od razu zatwierdzone!
  reason: "Serwisant zgubi≈Ç czƒô≈õƒá"
}
```

### 2. **Deadline + Express Charge** ‚úÖ
```javascript
// System automatycznie sprawdza godzinƒô:
const isAfterDeadline = currentTime > "15:00";
const expressCharge = (isAfterDeadline && urgency === 'urgent') ? 25 : 0;

// Notyfikacja:
"üö® Express po deadline! (+25z≈Ç)"
```

### 3. **Low Stock Alert** ‚úÖ
```javascript
// Gdy serwisant u≈ºyje ostatniƒÖ czƒô≈õƒá:
POST /api/inventory/personal/use
{
  parts: [{ partId: "PART001", quantity: 2 }]  // Ostatnie 2 szt
}

// Response:
{
  "lowStockAlert": true,
  "outOfStockParts": ["≈Åo≈ºysko bƒôbna Samsung"]
}

// Automatyczna notyfikacja do logistyka:
"‚ö†Ô∏è Low stock alert! Adam Nowak zu≈ºy≈Ç ostatnie: ≈Åo≈ºysko bƒôbna Samsung"
```

### 4. **Historia + Audit Trail** ‚úÖ
- ‚úÖ `part-usage.json` - Ka≈ºde u≈ºycie czƒô≈õci zapisane
- ‚úÖ `adjustmentHistory` - Historia wszystkich korekt magazynu
- ‚úÖ `assignedBy`, `restockedBy` - Kto i kiedy
- ‚úÖ Link do faktury (`invoiceId`)

### 5. **Integracja z OCR** ‚úÖ
```javascript
// Po OCR tabliczki:
POST /api/ocr/device-plate ‚Üí ocrId: "OCR-2025-10-001"

// Zam√≥wienie z linkiem do OCR:
POST /api/part-requests
{
  ocrId: "OCR-2025-10-001",  // Link do rozpoznanej tabliczki
  deviceInfo: null            // Pobrane z OCR
}
```

---

## üìä STATYSTYKI

### Utworzone pliki:
- **9 nowych endpoint√≥w API** (part-requests: 5, personal inventory: 5, notifications: 1)
- **~1800 linii kodu**
- **Pe≈Çna integracja z notyfikacjami**

### Funkcje:
- ‚úÖ Admin ordering dla innych serwisant√≥w
- ‚úÖ Auto-approve dla admin√≥w
- ‚úÖ Deadline detection + express charge
- ‚úÖ Low stock alerts
- ‚úÖ Audit trail + historia
- ‚úÖ Statystyki magazyn√≥w
- ‚úÖ Integracja z OCR

---

## üöÄ NASTƒòPNY KROK: DZIE≈É 4

Teraz tworzymy najbardziej zaawansowanƒÖ czƒô≈õƒá:
1. **Konsolidacja zam√≥wie≈Ñ** (same paczkomat ‚Üí oszczƒôdno≈õƒá 15z≈Ç)
2. **Multi-delivery** (jedno zam√≥wienie ‚Üí wiele adres√≥w)
3. **Auto-assign po dostawie** (automatyczne przypisanie do magazyn√≥w)
4. **API konfiguracji** (deadline, express charge, consolidation settings)

**Gotowy na Dzie≈Ñ 4?** üéØ
