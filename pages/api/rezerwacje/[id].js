// pages/api/rezerwacje/[id].js - API do zarzƒÖdzania pojedynczƒÖ rezerwacjƒÖ

import { createClient } from '@supabase/supabase-js';
import { 
    readReservations, 
    updateReservation, 
    deleteReservation
} from '../../../utils/dataStorage';
import {
    convertReservationToClientOrder,
    readClients,
    readOrders,
    updateOrder,
    writeClients,
    writeOrders
} from '../../../utils/clientOrderStorage';

// Inicjalizacja Supabase
let supabase = null;
try {
  const supabaseUrl = (process.env.NEXT_PUBLIC_SUPABASE_URL || '').trim();
  const supabaseKey = (process.env.SUPABASE_SERVICE_ROLE_KEY || '').trim();
  
  if (supabaseUrl && supabaseKey && 
      !supabaseUrl.includes('twoj-projekt') && 
      !supabaseKey.includes('wtetrtvtblzkguoxfumx')) {
    supabase = createClient(supabaseUrl, supabaseKey);
    console.log('‚úÖ Supabase initialized in rezerwacje/[id].js');
  }
} catch (error) {
  console.error('‚ùå Supabase initialization error:', error);
}

export default async function handler(req, res) {
    const { id } = req.query;

    if (req.method === 'GET') {
        // Pobierz pojedynczƒÖ rezerwacjƒô
        try {
            const rezerwacje = readReservations();
            const rezerwacja = rezerwacje.find(r => r.id.toString() === id.toString());

            if (!rezerwacja) {
                return res.status(404).json({ message: 'Rezerwacja nie znaleziona' });
            }

            return res.status(200).json(rezerwacja);
        } catch (error) {
            console.error('B≈ÇƒÖd pobierania rezerwacji:', error);
            return res.status(500).json({ message: 'B≈ÇƒÖd serwera' });
        }
    }

    if (req.method === 'PUT') {
        // Aktualizuj rezerwacjƒô
        try {
            console.log(`üìù Aktualizacja rezerwacji ${id}:`, req.body);

            // üöÄ NAJPIERW: Je≈õli zmiana statusu na "contacted", utw√≥rz zlecenie!
            if (req.body.status === 'contacted') {
                console.log('üéØ Status zmieniony na "contacted" - tworzƒô zlecenie...');
                
                // Pobierz rezerwacjƒô z Supabase lub lokalnie
                let rezerwacja = null;
                if (supabase) {
                    const { data } = await supabase
                        .from('rezerwacje')
                        .select('*')
                        .eq('id', id)
                        .single();
                    rezerwacja = data;
                } else {
                    const rezerwacje = readReservations();
                    rezerwacja = rezerwacje.find(r => r.id.toString() === id.toString());
                }

                if (rezerwacja && rezerwacja.status !== 'contacted') {
                    // Sprawd≈∫ czy zam√≥wienie ju≈º istnieje
                    const orders = await readOrders();
                    let existingOrder = orders.find(o => 
                        o.orderNumber === rezerwacja.orderNumber ||
                        o.orderNumber === rezerwacja.data?.orderNumber ||
                        o.originalReservationId === rezerwacja.id
                    );

                    if (!existingOrder) {
                        console.log('üì¶ Tworzƒô nowe zlecenie dla rezerwacji...');
                        
                        // Konwertuj rezerwacjƒô na klienta i zam√≥wienie
                        const reservationData = rezerwacja.data || rezerwacja;
                        const converted = await convertReservationToClientOrder(reservationData);
                        
                        console.log(`‚úÖ Zlecenie utworzone lokalnie: ${converted.order.orderNumber}`);
                        
                        // üöÄ Zapisz klienta do Supabase
                        if (supabase) {
                            console.log('üíæ Zapisujƒô klienta do Supabase...');
                            const clientPayload = {
                                name: converted.client.name,
                                phone: converted.client.phone,
                                email: converted.client.email || '',
                                address: converted.client.address || '',
                                city: converted.client.city || '',
                                street: converted.client.street || '',
                                postal_code: converted.client.postalCode || '',
                                created_at: converted.client.createdAt || new Date().toISOString(),
                                data: converted.client // pe≈Çne dane w JSONB
                            };
                            
                            const { data: clientData, error: clientError } = await supabase
                                .from('clients')
                                .insert([clientPayload])
                                .select()
                                .single();
                            
                            if (!clientError && clientData) {
                                console.log(`‚úÖ Klient zapisany w Supabase: ID ${clientData.id}`);
                                req.body.clientId = clientData.id;
                                
                                // üöÄ Zapisz zlecenie do Supabase
                                console.log('üíæ Zapisujƒô zlecenie do Supabase...');
                                const orderPayload = {
                                    order_number: converted.order.orderNumber,
                                    client_id: clientData.id,
                                    category: converted.order.category,
                                    service_type: converted.order.serviceType,
                                    description: converted.order.description || '',
                                    status: converted.order.status || 'pending',
                                    priority: converted.order.priority || 'normal',
                                    scheduled_date: converted.order.scheduledDate || null,
                                    created_at: converted.order.createdAt || new Date().toISOString(),
                                    data: converted.order // pe≈Çne dane w JSONB
                                };
                                
                                const { data: orderData, error: orderError } = await supabase
                                    .from('orders')
                                    .insert([orderPayload])
                                    .select()
                                    .single();
                                
                                if (!orderError && orderData) {
                                    console.log(`‚úÖ Zlecenie zapisane w Supabase: ID ${orderData.id}`);
                                    converted.order.id = orderData.id;
                                    converted.order.orderNumber = orderData.order_number || converted.order.orderNumber;
                                    req.body.orderId = orderData.id;
                                    req.body.orderNumber = orderData.order_number || converted.order.orderNumber;
                                } else {
                                    console.error('‚ùå B≈ÇƒÖd zapisu zlecenia do Supabase:', orderError);
                                }
                            } else {
                                console.error('‚ùå B≈ÇƒÖd zapisu klienta do Supabase:', clientError);
                            }
                        }
                        
                        // Aktualizuj req.body z informacjami o zleceniu
                        if (!req.body.orderId) {
                            req.body.orderId = converted.order.id;
                        }
                        if (!req.body.orderNumber) {
                            req.body.orderNumber = converted.order.orderNumber;
                        }
                        if (!req.body.clientId) {
                            req.body.clientId = converted.client.id;
                        }
                    } else {
                        console.log(`‚úÖ Zlecenie ju≈º istnieje: ${existingOrder.orderNumber}`);
                        req.body.orderId = existingOrder.id;
                        req.body.orderNumber = existingOrder.orderNumber;
                    }
                }
            }

            // ‚úÖ Teraz zaktualizuj Supabase
            if (supabase) {
                // Konwertuj camelCase ‚Üí snake_case dla Supabase
                const toSnakeCase = (obj) => {
                    if (Array.isArray(obj)) return obj.map(toSnakeCase);
                    if (obj !== null && typeof obj === 'object') {
                        return Object.keys(obj).reduce((result, key) => {
                            const snakeKey = key.replace(/([A-Z])/g, '_$1').toLowerCase();
                            result[snakeKey] = toSnakeCase(obj[key]);
                            return result;
                        }, {});
                    }
                    return obj;
                };

                const updatePayload = {
                    ...toSnakeCase(req.body),
                    updated_at: new Date().toISOString()
                };

                console.log('üì§ Supabase update payload:', Object.keys(updatePayload).join(', '));

                const { data, error } = await supabase
                    .from('rezerwacje')
                    .update(updatePayload)
                    .eq('id', id)
                    .select()
                    .single();

                if (!error && data) {
                    console.log('‚úÖ Rezerwacja zaktualizowana w Supabase:', data);
                    return res.status(200).json({
                        message: 'Rezerwacja zaktualizowana',
                        data: data
                    });
                } else if (error) {
                    console.error('‚ùå Supabase update error:', error);
                    // Kontynuuj do lokalnego fallbacku
                }
            }

            // Fallback: lokalne pliki JSON
            const rezerwacje = readReservations();
            const index = rezerwacje.findIndex(r => r.id?.toString() === id?.toString());

            if (index === -1) {
                return res.status(404).json({ message: 'Rezerwacja nie znaleziona' });
            }

            // Zaktualizuj rezerwacjƒô lokalnie
            const updatedReservation = updateReservation(id, req.body);

            if (updatedReservation) {
                // Spr√≥buj te≈º zaktualizowaƒá odpowiadajƒÖce dane w systemie klient+zam√≥wienie
                try {
                    const clients = await readClients();
                    const orders = await readOrders();

                    // Znajd≈∫ klienta po danych z rezerwacji
                    const clientIndex = clients.findIndex(c =>
                        c.name === updatedReservation.name || c.phone === updatedReservation.phone
                    );

                    if (clientIndex !== -1) {
                        // Aktualizuj dane klienta
                        clients[clientIndex] = {
                            ...clients[clientIndex],
                            name: updatedReservation.name,
                            phone: updatedReservation.phone,
                            email: updatedReservation.email,
                            address: updatedReservation.address,
                            city: updatedReservation.city,
                            street: updatedReservation.street
                        };

                        // Znajd≈∫ i zaktualizuj zam√≥wienie
                        const orderIndex = orders.findIndex(o => o.clientId === clients[clientIndex].id);
                        if (orderIndex !== -1) {
                            orders[orderIndex] = {
                                ...orders[orderIndex],
                                category: updatedReservation.category,
                                serviceType: updatedReservation.device,
                                description: updatedReservation.description,
                                availability: updatedReservation.availability,
                                scheduledDate: updatedReservation.date,
                                status: updatedReservation.status,
                                priority: updatedReservation.priority || 'normal'
                            };
                        }

                        // Zapisz zmiany
                        await writeClients(clients);
                        await writeOrders(orders);
                        console.log('‚úÖ Zaktualizowano powiƒÖzane dane klient+zam√≥wienie');
                    }
                } catch (syncError) {
                    console.warn('‚ö†Ô∏è Nie uda≈Ço siƒô zsynchronizowaƒá z systemem klient+zam√≥wienie:', syncError);
                }

                console.log('‚úÖ Rezerwacja zaktualizowana lokalnie:', updatedReservation);
                return res.status(200).json({
                    message: 'Rezerwacja zaktualizowana',
                    data: updatedReservation
                });
            } else {
                return res.status(500).json({ message: 'B≈ÇƒÖd aktualizacji rezerwacji' });
            }

        } catch (error) {
            console.error('B≈ÇƒÖd aktualizacji rezerwacji:', error);
            return res.status(500).json({ message: 'B≈ÇƒÖd serwera' });
        }
    }

    if (req.method === 'DELETE') {
        // Usu≈Ñ rezerwacjƒô
        try {
            console.log(`üóëÔ∏è Usuwanie rezerwacji ${id}`);

            const success = deleteReservation(id);

            if (success) {
                console.log('‚úÖ Rezerwacja usuniƒôta');
                return res.status(200).json({ 
                    success: true,
                    message: 'Rezerwacja usuniƒôta' 
                });
            } else {
                return res.status(404).json({ 
                    success: false,
                    message: 'Rezerwacja nie znaleziona' 
                });
            }

        } catch (error) {
            console.error('B≈ÇƒÖd usuwania rezerwacji:', error);
            return res.status(500).json({ message: 'B≈ÇƒÖd serwera' });
        }
    }

    return res.status(405).json({ message: 'Metoda nie obs≈Çugiwana' });
}
